{"version":3,"file":"static/js/833.8d69a79e.chunk.js","mappings":"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","sources":["pages/poster/index.jsx"],"sourcesContent":["import React, { useRef, useState, useEffect } from 'react'\r\nimport './index.scss'\r\nimport { Toast } from 'antd-mobile'\r\nimport Crumbs1 from '../../components/crumbs1'\r\nimport utils from '../../utils/index'\r\nimport QRCode from 'qrcodejs2'\r\nimport { promotionSharePosterListApi } from '../../axios/api'\r\nimport { useLocation } from 'react-router-dom'\r\nimport axios from 'axios'\r\nconst saveBtnImage = require('../../assets/saveposter.png')\r\nfunction Poster () {\r\n  const [data, setData] = useState({\r\n    user_name: '',\r\n    user_avatar: '',\r\n    poster_url: ''\r\n  })\r\n  const fullRef = useRef()\r\n  const viewRef = useRef()\r\n  const location = useLocation()\r\n  // 生成二维码函数\r\n  const getQrcode = (qWidth, qHeight, qText, qRender, dom) => {\r\n    return new QRCode(dom, {\r\n      width: qWidth,\r\n      height: qHeight,\r\n      text: qText,\r\n      render: qRender,\r\n      correctLevel: 1\r\n    })\r\n  }\r\n  // 转换成blob\r\n  const getBlob = (base64) => {\r\n    const mimeString = base64.split(',')[0].split(':')[1].split(';')[0] // mime类型\r\n    const byteString = atob(base64.split(',')[1]) // base64 解码\r\n    const arrayBuffer = new ArrayBuffer(byteString.length) // 创建缓冲数组\r\n    const intArray = new Uint8Array(arrayBuffer) // 创建视图\r\n    for (let i = 0; i < byteString.length; i += 1) {\r\n      intArray[i] = byteString.charCodeAt(i)\r\n    }\r\n    return new Blob([intArray], {\r\n      type: mimeString\r\n    })\r\n  }\r\n  const blobToBase64 = (blob) => {\r\n    console.log('blobToBase64 1', blob)\r\n    const fileReader = new FileReader()\r\n    fileReader.readAsDataURL(blob)\r\n    return new Promise((resolve) => {\r\n      fileReader.onload = (e) => {\r\n        resolve(e.target.result)\r\n      }\r\n    })\r\n  }\r\n  // 获取二进制流 转base 转blob\r\n  const getImageToBlob = async (url) => {\r\n    const res = await axios.get(url, { responseType: 'blob' })\r\n    const baseData = await blobToBase64(new Blob([res.data], { type: res.headers['content-type'] }))\r\n    // const blob = getBlob(baseData)\r\n    return baseData\r\n  }\r\n  const getData = async () => {\r\n    const res = await promotionSharePosterListApi({\r\n      promotion_id: location.state.id\r\n    })\r\n    if (res.code !== 0) {\r\n      return false\r\n    }\r\n    const resData = {\r\n      posterUrl: '',\r\n      userAvatar: ''\r\n    }\r\n    resData.posterUrl = await getImageToBlob(res.data.poster_url)\r\n    resData.userAvatar = await getImageToBlob(res.data.user_avatar)\r\n    console.log('resData', resData)\r\n    setData({ ...res.data, ...resData })\r\n  }\r\n\r\n  const initCanvas = () => {\r\n    console.log('viewRef', viewRef)\r\n    if (fullRef.current && viewRef.current) {\r\n      // 获取父盒子宽度\r\n      const full = fullRef.current\r\n      const canvas = viewRef.current\r\n      const scaleNumber = 3 // 展示的是几倍图  越大越清晰\r\n      canvas.width = full.offsetWidth * scaleNumber\r\n      canvas.height = full.offsetHeight * scaleNumber\r\n      // 参照比例\r\n      const scaleWidth = 375\r\n      const scaleHeight = 517\r\n      const ava = {\r\n        x: 0,\r\n        y: 0,\r\n        width: 0,\r\n        height: 0\r\n      }// 头像\r\n      ava.x = scaleNumber * full.offsetWidth * 14 / scaleWidth\r\n      ava.y = scaleNumber * full.offsetHeight * 17 / scaleHeight\r\n      ava.width = scaleNumber * full.offsetWidth * 32 / scaleWidth\r\n      ava.height = scaleNumber * full.offsetWidth * 32 / scaleWidth\r\n      // 文本\r\n      const title = {\r\n        x: scaleNumber * full.offsetWidth * 50 / scaleWidth,\r\n        y: scaleNumber * full.offsetHeight * 37 / scaleHeight,\r\n        fontSize: scaleNumber * full.offsetHeight * 15 / scaleHeight\r\n      }\r\n      // 二维码\r\n      const qr = {\r\n        x: scaleNumber * full.offsetWidth * 147 / scaleWidth,\r\n        y: scaleNumber * full.offsetHeight * 405 / scaleHeight,\r\n        width: scaleNumber * full.offsetWidth * 82 / scaleWidth,\r\n        height: scaleNumber * full.offsetWidth * 82 / scaleWidth\r\n      }\r\n      const ctx = canvas.getContext('2d')\r\n      // 创建图片 背景图\r\n      let image = null\r\n      image = new Image()\r\n      image.crossOrigin = 'anonymous'\r\n      image.setAttribute('crossOrigin', 'anonymous')\r\n\r\n      // 二维码图片\r\n      const codeImg = new Image()\r\n      codeImg.setAttribute('crossOrigin', 'anonymous')\r\n      codeImg.crossOrigin = 'anonymous'\r\n      // 生成二维码\r\n      const qrCanvas = document.createElement('div')\r\n      qrCanvas.height = scaleNumber * qr.height\r\n      qrCanvas.width = scaleNumber * qr.width\r\n      const shareUrl = window.location.protocol + '//' + window.location.host + `/#/layout/home?id=${location.state.id}&share_sign=${data.share_sign}`\r\n      const qrcodeObj = getQrcode(qr.width, qr.height, shareUrl, 'canvas', qrCanvas)\r\n      const codeCanvas = qrcodeObj._el.querySelector('canvas')\r\n      const base64Text = codeCanvas.toDataURL('image/png')\r\n      // const blob = getBlob(base64Text) // 将base64转换成blob对象\r\n      console.log('qrcodeObj src', qrcodeObj._el.children[1])\r\n      codeImg.onload = function () {\r\n        console.log('codeImg.src1', codeImg.src)\r\n        ctx.drawImage(codeImg, qr.x, qr.y, qr.width, qr.width)\r\n      }\r\n      codeImg.onerror = function (e) {\r\n      }\r\n\r\n      // 设置图片地址\r\n      // image.src = data.poster_url + '?v=' + Math.random()\r\n      // image.src = data.posterUrl\r\n      // 必须要在onLoad之后再进行绘制图片，否则不会渲染\r\n      image.onerror = function (e) {\r\n        console.log('image error', e)\r\n      }\r\n      image.onload = function () {\r\n        console.log('image')\r\n        // 4各参数 图片的起始坐标和宽高\r\n        ctx.drawImage(image, 0, 0, scaleNumber * full.offsetWidth, scaleNumber * full.offsetHeight)\r\n\r\n        // 绘制文本\r\n        ctx.font = `${title.fontSize}px PingFang SC` // 设置文案大小和字体\r\n        // ctx.direction = 'ltr' // 文本方向从左向右\r\n        ctx.textAlign = 'left' // 左对齐\r\n        // ctx.fillStyle = '#ffff'\r\n        console.log('title.x, title.y', title.x, title.y)\r\n        ctx.fillText(data.user_name, title.x, title.y)\r\n\r\n        // 赋值\r\n        codeImg.src = base64Text\r\n\r\n        // 层级之上\r\n        const avaImg = new Image()\r\n        avaImg.crossOrigin = 'anonymous'\r\n        avaImg.setAttribute('crossOrigin', 'anonymous')\r\n        avaImg.onload = function () {\r\n          console.log('ava.x, ava.y, ava.width, ava.height', ava.x, ava.y, ava.width, ava.height)\r\n          // 创建圆形裁剪路径\r\n          ctx.arc(ava.x + (ava.width / 2), ava.y + (ava.height / 2), ava.width / 2, 0, Math.PI * 2)\r\n          ctx.clip()\r\n          // 创建完后绘制\r\n          ctx.drawImage(avaImg, ava.x, ava.y, ava.width, ava.height)\r\n        }\r\n        avaImg.src = data.user_avatar\r\n        console.log('avaImg src', avaImg.src)\r\n      }\r\n      image.src = data.poster_url\r\n      console.log('image.src', image)\r\n    }\r\n  }\r\n\r\n  // 保存海报到本地\r\n  const handleSavePoster = () => {\r\n    // onSave()\r\n    try {\r\n      const posterBase = viewRef.current.toDataURL('image/png;base64')\r\n      utils.ownApp(() => {\r\n        utils.saveBase64Image(posterBase)\r\n      }, () => {\r\n        const btn = document.createElement('a')\r\n        btn.download = '分享海报'\r\n        btn.href = posterBase\r\n        btn.click()\r\n      })\r\n    } catch (error) {\r\n      console.log(error)\r\n      alert(error.message)\r\n    }\r\n  }\r\n  const onSave = () => {\r\n    viewRef.current.toBlob((blob) => {\r\n      const timestamp = Date.now().toString()\r\n      const a = document.createElement('a')\r\n      document.body.append(a)\r\n      a.download = `${timestamp}.png`\r\n      a.href = URL.createObjectURL(blob)\r\n      a.click()\r\n      a.remove()\r\n    })\r\n  }\r\n  // 导出图片成base64\r\n  const onExportBase64 = () => {\r\n    const posterBase = viewRef.current.toDataURL('image/png;base64')\r\n    return posterBase\r\n  }\r\n  // 分享到微信微博\r\n  const handleShareWebToWX = (share_way) => {\r\n    const share_title = location.state.title || '元音符'\r\n    // const url = window.location.origin + '/#/layout/home?share_sign=' + data.share_sign + '&id=' + location.state.id\r\n    const img = onExportBase64()\r\n    utils.shareBase64Image(share_title, share_way, img)\r\n  }\r\n  // const bottomRender = () => {\r\n  //   let bottomComponent = null\r\n  //   utils.ownApp(() => {\r\n  //     bottomComponent = (\r\n  //     <div className=\"bottom-box-share\">\r\n  //       <div className=\"line\">\r\n  //         <div className=\"line-1\"></div>\r\n  //         <div className=\"line-1\"></div>\r\n  //       </div>\r\n  //       <div className=\"share-title\">分享至微信或朋友圈</div>\r\n  //       <div className=\"share-btns\">\r\n  //         <div className=\"share-btns-friends\">\r\n  //           <img onClick={() => handleShareWebToWX()} src={require('../../assets/share-wx.png')} alt=\"\" />\r\n  //           <span>微信</span>\r\n  //         </div>\r\n  //         <div className=\"share-btns-friends\">\r\n  //         <img onClick={() => handleShareWebToWX()} src={require('../../assets/share-friends.png')} alt=\"\" />\r\n  //           <span>朋友圈</span>\r\n  //         </div>\r\n  //       </div>\r\n  //     </div>\r\n  //     )\r\n  //   }, () => {\r\n\r\n  //   })\r\n  //   return bottomComponent\r\n  // }\r\n  const bottomRender = () => {\r\n    return (\r\n      <div className=\"bottom-box-share\">\r\n        <div className=\"share-1\">可分享至</div>\r\n        <img src={require('../../assets/share-wx.png')} alt=\"\" className=\"share-2\" onClick={() => handleShareWebToWX('wxFriend')} />\r\n        <img src={require('../../assets/share-friends.png')} alt=\"\" className=\"share-3\" onClick={() => handleShareWebToWX('wxFriend')} />\r\n        <img src={require('../../assets/share-weibo.png')} alt=\"\" className=\"share-3\" onClick={() => handleShareWebToWX('weibo')} />\r\n      </div>\r\n    )\r\n  }\r\n  useEffect(() => {\r\n    getData()\r\n    return () => {\r\n\r\n    }\r\n  }, [])\r\n  useEffect(() => {\r\n    initCanvas()\r\n  }, [viewRef, fullRef, data])\r\n  return (\r\n    <div className=\"poster\">\r\n      {/* <Crumbs1 text=\"活动海报\"></Crumbs1> */}\r\n      {\r\n        data.share_sign\r\n          ? (\r\n            <>\r\n            <div className=\"share-tips\">邀请好友参加，可获得更多抽奖机会</div>\r\n            <div className=\"poster-box\">\r\n            <div className='full' ref={fullRef}>\r\n              <canvas ref={viewRef}></canvas>\r\n            </div>\r\n          </div>\r\n          <div className=\"bottom-box\">\r\n          {/* <a className=\"save-the\" download href=\"javascript:;\" onClick={() => handleSavePoster()}>\r\n            点击保存海报\r\n          </a> */}\r\n          <img src={saveBtnImage} className=\"save-the\" onClick={() => handleSavePoster()} />\r\n          {\r\n            bottomRender()\r\n          }\r\n        </div>\r\n            </>\r\n\r\n            )\r\n          : null\r\n\r\n      }\r\n\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default Poster\r\n"],"names":["saveBtnImage","require","useState","user_name","user_avatar","poster_url","data","setData","fullRef","useRef","viewRef","location","useLocation","blobToBase64","blob","console","log","fileReader","FileReader","readAsDataURL","Promise","resolve","onload","e","target","result","getImageToBlob","url","axios","responseType","res","Blob","type","headers","baseData","getData","promotionSharePosterListApi","promotion_id","state","id","code","resData","posterUrl","userAvatar","initCanvas","current","full","canvas","width","offsetWidth","height","offsetHeight","scaleWidth","scaleHeight","ava","x","y","title","fontSize","qr","ctx","getContext","image","Image","crossOrigin","setAttribute","codeImg","qrCanvas","document","createElement","shareUrl","window","protocol","host","share_sign","qrcodeObj","qWidth","qHeight","qText","qRender","dom","QRCode","text","render","correctLevel","base64Text","_el","querySelector","toDataURL","children","src","drawImage","onerror","font","textAlign","fillText","avaImg","arc","Math","PI","clip","handleShareWebToWX","share_way","share_title","img","utils","useEffect","className","ref","onClick","posterBase","btn","download","href","click","error","alert","message","handleSavePoster","alt"],"sourceRoot":""}